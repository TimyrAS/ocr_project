"""
Конфигурация для скрипта оцифровки карточек клиентов.
Заполните свои ключи и пути перед запуском.
"""
from pathlib import Path

# Абсолютный путь к папке проекта (работает после переноса каталога)
BASE_DIR = Path(__file__).resolve().parent


# ============================================================
# GOOGLE VISION API
# ============================================================
GOOGLE_VISION_CREDENTIALS = str(BASE_DIR / "micro-weaver-486910-g5-d70b970e607a.json")

# ============================================================
# ANTHROPIC (CLAUDE) API через vibeproxy
# ============================================================
ANTHROPIC_API_KEY = "sk-ant-placeholder"
ANTHROPIC_BASE_URL = "http://localhost:8317"
CLAUDE_MODEL = "claude-sonnet-4-20250514"

# ============================================================
# ПУТИ К ФАЙЛАМ
# ============================================================
INPUT_FOLDER = str(BASE_DIR / "JPG")
OUTPUT_FILE = str(BASE_DIR / "clients_database.xlsx")
CACHE_FOLDER = str(BASE_DIR / "ocr_cache")

# ============================================================
# НАСТРОЙКИ ОБРАБОТКИ
# ============================================================
IMAGE_EXTENSIONS = ['.jpg', '.jpeg', '.png', '.heic', '.webp']
MAX_RETRIES = 3
API_DELAY = 0.5
SAVE_EVERY_N = 10

# ============================================================
# НАСТРОЙКИ ГРУППИРОВКИ КЛИЕНТОВ
# ============================================================
# Порог нечёткого сопоставления имён (0.0 - 1.0)
# 0.75 = имена совпадают на 75%+ → считаем одним клиентом
# Чем выше — тем строже (меньше ложных совпадений, но можно пропустить одинаковых)
# Чем ниже — тем мягче (больше объединяет, но может ошибочно склеить разных)
FUZZY_NAME_THRESHOLD = 0.60

# ============================================================
# НАСТРОЙКИ ДЕДУПЛИКАЦИИ
# ============================================================
# Порог совпадения OCR-текста для обнаружения дублей (0.0 - 1.0)
# 0.90 = тексты совпадают на 90%+ → считаем дублем (рекомендуется)
# Скрипт также сравнивает перцептивный хэш изображений
OCR_DUPLICATE_THRESHOLD = 0.90

# Размер для перцептивного хэша (чем больше — тем точнее, но медленнее)
IMAGE_HASH_SIZE = 16

# ============================================================
# РЕКОНСТРУКЦИЯ ТАБЛИЦ ИЗ VISION API
# ============================================================
# Включить реконструкцию таблиц из структурных данных Vision API
# Vision возвращает block_type=TABLE для блоков-таблиц;
# модуль восстанавливает строки/колонки по bounding box и отдаёт Claude
OCR_TABLE_RECONSTRUCTION = True

# Допуск по Y-координатам для группировки слов в строки таблицы (пиксели)
# Увеличьте, если таблицы имеют большой межстрочный интервал
TABLE_ROW_TOLERANCE_PX = 15

# Сохранять debug-информацию по bbox и confidence для каждого изображения
# Файлы сохраняются в OCR_DEBUG_FOLDER/<имя_без_расширения>.json
OCR_SAVE_BBOX_DEBUG = False

# Папка для debug-файлов bbox/confidence
OCR_DEBUG_FOLDER = str(BASE_DIR / "ocr_debug")

# ============================================================
# ИЗВЕСТНЫЕ ВРАЧИ/КОНСУЛЬТАНТЫ КЛИНИКИ
# ============================================================
# Скрипт использует этот список для коррекции OCR-ошибок
# в именах врачей (рукописный текст часто распознаётся с ошибками)
KNOWN_DOCTORS = [
    "Асшеман Оксана",
    "Калгимбаева Оксана",
    "Крошка Рада",
    "Уварова Ольга",
    "Шарипова Эльвира",
    "Житникова Виктория",
]

# Маппинг коротких имён из БД «Привилегия» → полные ФИО
# БД использует формат «Оксана А. - врач», OCR выдаёт «Асшеман Оксана»
DB_DOCTOR_MAP = {
    "Оксана А. - врач":            "Асшеман Оксана",
    "Оксана К. - врач":            "Калгимбаева Оксана",
    "Рада К. - врач":              "Крошка Рада",
    "Ольга У. - врач":             "Уварова Ольга",
    "Элвира Ш. - косметолог":      "Шарипова Эльвира",
    "Виктория Ж. - косметолог":    "Житникова Виктория",
    "Ольга А. - врач":             "Ольга А.",
    "Аяжан Е. - админ":            "Аяжан Е.",
    "Мая А. - админ":              "Мая А.",
    "Роксана М. - мастер":         "Роксана М.",
    "Жанара Б. - врач":            "Жанара Б.",
    "Виктория Ж. - админ":         "Житникова Виктория",
}

# ============================================================
# БАЗА ДАННЫХ «ПРИВИЛЕГИЯ» (для сверки)
# ============================================================
# Выгрузка из CRM клиники — эталон для проверки оцифрованных карточек
DB_PRIVILAGE_PATH = str(BASE_DIR / "db_privilage.xlsx")

# Столбцы БД (для парсинга)
DB_COLUMNS = {
    "id":       "ID Клиента",
    "name":     "Клиент",
    "phone":    "Телефон",
    "date":     "Дата визита",
    "doctor":   "Доктер",
    "service":  "Продаже процедура или косметика",
    "qty":      "Количество",
}

# Категории услуг из БД (для классификации)
SERVICE_CATEGORIES = {
    "Инъекционно":    ["Биорепарация", "Мезотерапия", "Ботулинотерапия", "Липолитики",
                       "Полимолочка", "Биоревитализация", "Плазмолифтинг",
                       "Коллагенотерапия", "Капельница", "Препараты для глаз",
                       "Биоармирование", "Контурная пластика", "Мезонити"],
    "Аппарат":        ["RF Микроигольчатый", "HARMONY XL PRO", "Эпиляция IP-laser",
                       "TESLA FORMER", "GENEO", "Jordi Shape", "Пикосекундный лазер"],
    "Эстетика":       ["Умные пилинг", "Уходовые процедуры", "Пилинги", "Массаж",
                       "Чистка"],
    "Консультация":   ["Консультация косметолога", "Консультация дерматолога",
                       "Anti-age консультация", "Тест ДНК"],
    "Косметика":      ["Teoxane", "Оттоме", "Hydropeptide", "Wamiles", "WiQo",
                       "Sesderma", "Payot", "Newsha", "REJURAN", "Elementre"],
}

# Порог совпадения ФИО для матчинга OCR ↔ БД (0.0 - 1.0)
# 0.70 = имена совпадают на 70%+ → считаем одним клиентом
DB_MATCH_THRESHOLD = 0.70

# Новые статусы для разделения картотеки и БД
STATUS_KARTOTEKA_FOUND = "Найден в OCR"
STATUS_DB_FOUND = "Найден в БД"
STATUS_DB_MAYBE = "Возможное совпадение в БД"
STATUS_DB_NOT_FOUND = "Нет в БД (новый для картотеки)"

# Минимальное количество слов в ФИО для "Найден в БД" без телефона
MIN_FIO_WORDS_FOR_CONFIDENT_MATCH = 2

# Максимальная длина OCR-текста в одной ячейке Excel (32767 - лимит Excel)
MAX_OCR_TEXT_LENGTH = 32000

# Порог fuzzy-матчинга для подтягивания полной строки в clients_not_found.xlsx
# 0.85 = устойчив к OCR-опечаткам, лишним пробелам, ё/е
NOT_FOUND_FUZZY_THRESHOLD = 0.85

# Правило подстроки в match_names(): проверять только по границам слов.
# True  → "Иванов" в "Иванов Иван" = 0.95 ✓, "Иван" в "Иванова" = пропуск (fuzzy ~0.73) ✓
# False → любая подстрока даёт 0.95 (старое поведение, подвержено ложноположительным)
SUBSTRING_WORD_BOUNDARY_ONLY = True

# --- Google Sheets (опционально) ---
# Путь к service account JSON
GSHEETS_CREDENTIALS = str(BASE_DIR / "festive-flame-487709-p2-9118afa23975.json")
# ID таблицы для выгрузки отчётов
GSHEETS_SPREADSHEET_ID = "1FafUgS49Pt7vklinDUZ4tec8v_8dT2foUyBJ1NTamA0"
# Флаг выгрузки результатов в Google Sheets
GSHEETS_UPLOAD_ENABLED = True

# ============================================================
# МАППИНГ ПОЛЕЙ: КАРТОЧКА (OCR) → БД ПРИВИЛЕГИЯ
# ============================================================
# Бумажная карточка и БД используют разные названия для одних и тех же данных.
# Нормализация приводит OCR к формату, совместимому с БД.
#
# КАРТОЧКА (OCR)                    →   БД «Привилегия»
# ─────────────────────────────────────────────────────────
# Ф.И.О / пациент / patient_name   →   Клиент
# Контакты / телефон / phone        →   Телефон
# Дата приобретения / первый визит  →   Дата визита
# Консультант / Врач / doctor       →   Доктер
# Процедура / procedure_name        →   Продаже процедура или косметика
# Кол-во / количество               →   Количество
# Дата рождения                     →   (нет в БД — доп. поле)
# ИИН / паспорт                     →   (нет в БД — доп. поле)
# Email / Мессенджер                →   (нет в БД — доп. поле)

# --- Маппинг столбцов OCR Excel → нормализованные имена (как в БД) ---
# Лист "Клиенты"
OCR_CLIENT_FIELD_MAP = {
    # OCR-столбец            → нормализованное имя (ближе к БД)
    "ID":                     "ID",
    "ФИО":                    "Клиент",
    "Телефон":                "Телефон",
    "Email":                  "Email",
    "Мессенджер":             "Мессенджер",
    "Дата рождения":          "Дата рождения",
    "Возраст":                "Возраст",
    "Пол":                    "Пол",
    "Гражданство":            "Гражданство",
    "ИИН / Паспорт":          "ИИН",
    "Адрес":                  "Адрес",
    "Экстренный контакт":     "Экстренный контакт",
    "Скидка":                 "Скидка",
    "Источник инфо":          "Источник",
    "Аллергии":               "Аллергии",
    "Консультант/Врач":       "Доктор",
    "Дата создания карты":    "Дата первого визита",
    "Дата последнего визита": "Дата последнего визита",
    "Фото (файл)":           "Фото",
    "Кол-во страниц":        "Страниц",
    "Файлы-источники":       "Источники_файлы",
    "OCR_Таблицы_MD":        "Таблицы_MD",
    "OCR_Таблицы_CSV":       "Таблицы_CSV",
}

# Лист "Процедуры"
OCR_PROCEDURE_FIELD_MAP = {
    "ID":          "ID",
    "ФИО":         "Клиент",
    "Дата":        "Дата визита",
    "Процедура":   "Процедура",
    "Описание":    "Описание",
    "Стоимость":   "Стоимость",
}

# Лист "Покупки"
OCR_PURCHASE_FIELD_MAP = {
    "ID":           "ID",
    "ФИО":          "Клиент",
    "Дата":         "Дата визита",
    "Консультант":  "Доктор",
    "Наименование": "Процедура",
    "Цена":         "Стоимость",
}

# Лист "Комплексы"
OCR_COMPLEX_FIELD_MAP = {
    "ID":            "ID",
    "Пациент":       "Клиент",
    "Контакты":      "Телефон",
    "Врач":          "Доктор",
    "Комплекс":      "Комплекс",
    "Дата покупки":  "Дата визита",
    "Стоимость":     "Стоимость",
    "№":             "Номер",
    "Процедура":     "Процедура",
    "Дата":          "Дата процедуры",
    "Кол-во":        "Количество",
    "Комментарий":   "Комментарий",
}

# Лист "Ботокс"
OCR_BOTOX_FIELD_MAP = {
    "ID":               "ID",
    "ФИО":              "Клиент",
    "Препарат":         "Препарат",
    "Область введения": "Зона",
    "Кол-во единиц":   "Количество",
    "Общая доза":       "Доза",
    "Дата процедуры":   "Дата визита",
    "Дата контроля":    "Дата контроля",
}

# Путь к нормализованному файлу
NORMALIZED_FILE = "clients_normalized.xlsx"

# Путь к файлу с клиентами, не найденными в БД
NOT_FOUND_CLIENTS_FILE = "clients_not_found.xlsx"

# --- Алиасы полей для поиска ФИО и Телефона в OCR ---
# verify_with_db.py ищет ФИО/телефон в любом из этих столбцов
FIO_ALIASES = ["фио", "клиент", "пациент", "имя", "name", "patient_name", "фамилия"]
PHONE_ALIASES = ["телефон", "phone", "контакты", "contacts", "тел", "моб"]

# ============================================================
# РЕЕСТР ОБРАБОТАННЫХ КАРТОЧЕК
# ============================================================
# Файл-реестр хранит список всех обработанных фото.
# При повторном запуске уже обработанные файлы пропускаются.
# Хранит: имя файла, MD5-хэш, дата обработки, тип страницы, ФИО клиента.
# Удалите этот файл, чтобы обработать все карточки заново.
PROCESSED_REGISTRY = str(BASE_DIR / "ocr_cache" / "processed_registry.json")

# ============================================================
# ФИНАЛЬНАЯ ВЕРИФИКАЦИЯ CLAUDE
# ============================================================
# Включить финальную верификацию через Claude API
ENABLE_FINAL_VERIFICATION = True

# Запускать финальную верификацию только для fallback-строк
# True = только для "Не найден" и "Возможно" (рекомендуется)
# False = для всех клиентов (дорого и медленно)
FINAL_VERIFICATION_FALLBACK_ONLY = True

# Размер батча для финальной верификации (клиентов в одном запросе)
VERIFICATION_BATCH_SIZE = 10

# Порог уверенности Claude для автоподтверждения (0-100)
# Клиенты с score >= порога помечаются как "Подтверждён"
CLAUDE_CONFIDENCE_THRESHOLD = 90

# Файл отчёта финальной верификации
FINAL_VERIFICATION_REPORT = "final_verification_report.xlsx"

# Максимальное количество возможных совпадений для ненайденных клиентов
MAX_POSSIBLE_MATCHES = 3

# ============================================================
# ЛОГИРОВАНИЕ
# ============================================================
# Папка для логов (каждый день — новый файл, старые сохраняются)
LOG_FOLDER = str(BASE_DIR / "ocr_logs")

# Уровень логирования: DEBUG (всё), INFO (основное), WARNING (только проблемы)
LOG_LEVEL = "DEBUG"

# ============================================================
# SMOKE-РЕЖИМ (env vars, выставляются через quality_baseline.py)
# ============================================================
# Для детерминированного smoke-прогона quality_baseline.py задаёт:
#   SMOKE_MODE=true               → пропустить внешние интеграции (GSheets),
#                                    устойчивость к повреждённым файлам, тихий лог
#   GSHEETS_UPLOAD_ENABLED=false  → принудительно отключить Google Sheets
#                                    (приоритет над GSHEETS_UPLOAD_ENABLED в config)
#   ENABLE_FINAL_VERIFICATION=false → пропустить Claude-верификацию (шаг 6.5)
# Эти флаги влияют только на runtime run_pipeline.py через env;
# значения ниже НЕ используются напрямую (они служат документацией).
SMOKE_MODE = False  # переопределяется env var SMOKE_MODE=true
